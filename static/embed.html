<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scramjet Embed</title>
    <script src="/assets/js/script.js?v=12"></script>

    <!-- Fonts (keep Inter as your base UI font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet" />


    <!-- Scramjet/BareMux -->
    <script src="/baremux/index.js"></script>
    <script src="/scram/scramjet.all.js"></script>
    <script>
        let wispurl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/wisp/";
    </script>

    <style>
        :root {
            /* Theme derived from #5e7594 (muted blue-gray) */
            --bg-0: #0f141a;
            /* deep base */
            --bg-1: #1a2230;
            --bg-2: #223044;
            --bg-accent-wash: rgba(94, 117, 148, 0.18);
            /* #5e7594 wash */
            --fg: #e9f2ff;
            --muted: #cfe0ff;

            /* Accents tuned to complement #5e7594: cool teal & ice-blue */
            --accent: #a7ffda;
            /* mint-teal pop */
            --accent-2: #7bd8ff;
            /* ice-blue */
            --bar-bg: rgba(255, 255, 255, 0.12);
            --bar-glow: 0 0 24px rgba(123, 216, 255, 0.45), 0 0 40px rgba(167, 255, 218, 0.25);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            color: var(--fg);
            background:
                radial-gradient(1200px 700px at 75% 120%, rgba(167, 255, 218, 0.05), transparent 50%),
                radial-gradient(900px 600px at 10% -10%, rgba(123, 216, 255, 0.06), transparent 50%),
                linear-gradient(180deg, var(--bg-0), var(--bg-1) 55%, var(--bg-2));
            overflow: hidden;
        }

        /* --- New loader --- */
        #fadeout {
            transition: opacity .35s ease;
        }

        #fadeout.hidden {
            opacity: 0;
        }

        #preloader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: grid;
            place-items: center;
            background: linear-gradient(180deg, rgba(0, 0, 0, .0), rgba(0, 0, 0, .18));
            transition: opacity .35s ease, visibility .35s ease;
        }

        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .speedlines {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            opacity: .40;
            mix-blend-mode: screen;
            -webkit-mask-image: linear-gradient(#0000, #000 20% 80%, #0000);
            mask-image: linear-gradient(#0000, #000 20% 80%, #0000);
        }

        .speedlines::before,
        .speedlines::after {
            content: "";
            position: absolute;
            inset: -20% -40%;
            background:
                repeating-linear-gradient(110deg, rgba(123, 216, 255, .10) 0 6px, transparent 6px 28px),
                repeating-linear-gradient(290deg, rgba(167, 255, 218, .10) 0 4px, transparent 4px 22px);
            filter: blur(1.2px);
            animation: streak 1.05s linear infinite;
        }

        .speedlines::after {
            animation-duration: .82s;
            opacity: .75;
        }

        @keyframes streak {
            from {
                transform: translate3d(-6%, -4%, 0)
            }

            to {
                transform: translate3d(6%, 4%, 0)
            }
        }

        .panel {
            width: min(780px, calc(100vw - 32px));
            padding: 28px 28px 22px;
            border-radius: 22px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 80px rgba(0, 0, 0, .6), inset 0 0 0 1px rgba(255, 255, 255, 0.02);
            position: relative;
            backdrop-filter: blur(6px);
        }

        .title {
            margin: 0 0 6px;
            font-weight: 800;
            letter-spacing: .3px;
            color: #fff;
            font-size: clamp(18px, 2.3vw, 22px);
            text-shadow: 0 0 12px rgba(123, 216, 255, .20);
        }

        .subtitle {
            margin: 0 0 18px;
            color: var(--muted);
            opacity: .95;
            font-size: 14px;
            line-height: 1.45;
        }

        .bar {
            position: relative;
            height: 10px;
            border-radius: 10px;
            background: var(--bar-bg);
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
        }

        .bar .fill {
            position: absolute;
            inset: 0 auto 0 0;
            width: 0%;
            border-radius: inherit;
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            box-shadow: var(--bar-glow);
            transition: width .16s cubic-bezier(.22, .61, .36, 1);
        }

        .bar::after {
            content: "";
            position: absolute;
            top: -60%;
            bottom: -60%;
            left: -20%;
            width: 25%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .55), transparent);
            transform: skewX(-18deg);
            animation: sweep 1s linear infinite;
            pointer-events: none;
        }

        @keyframes sweep {
            from {
                left: -30%
            }

            to {
                left: 120%
            }
        }

        .telemetry {
            margin-top: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 12px;
            color: #dcf7ff;
            opacity: .9
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--accent-2);
            box-shadow: 0 0 12px rgba(123, 216, 255, .7);
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .log {
            margin-top: 16px;
            height: 110px;
            overflow: hidden;
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .28);
            padding: 10px 12px 8px;
            font-size: 12px;
            line-height: 1.45;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New";
            color: #eafffb;
            -webkit-mask-image: linear-gradient(#000, #000 70%, #0000);
            mask-image: linear-gradient(#000, #000 70%, #0000);
        }

        .log .line {
            white-space: nowrap;
            opacity: .9
        }

        .line .key {
            color: #c9e9ff
        }

        .line .val {
            color: #ffffff
        }

        .line .ok {
            color: var(--accent)
        }

        .hint {
            margin-top: 14px;
            color: #bfe5ff;
            opacity: .85;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kbd {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New";
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, .25);
            background: rgba(255, 255, 255, .06);
        }

        /* App container (hidden until ready) */
        #iframe-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 1;
        }

        #iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
            position: relative;
            z-index: 1;
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {

            .speedlines,
            .bar::after {
                animation: none;
            }

            .fill {
                transition-duration: .001s;
            }
        }
    </style>
</head>

<body>
    <!-- Loader wrapper kept as #fadeout for compatibility -->
    <div id="fadeout">
        <div id="preloader" role="status" aria-live="polite" aria-label="Loading">
            <div class="speedlines" aria-hidden="true"></div>

            <div class="panel">
                <h1 id="theh1" class="title">Deploying Proxy</h1>
                <p id="thep" class="subtitle">This might take a bit</p>

                <div class="bar" aria-hidden="true">
                    <div class="fill" id="fill"></div>
                </div>

                <div class="telemetry">
                    <span class="dot" aria-hidden="true"></span>
                    <span class="mono" id="telemetry">0.0 MB/s • 0 ops/s • RTT ~ 0 ms</span>
                </div>

                <div class="log mono" id="log" aria-label="Loader activity stream"></div>

                <div class="hint">
                    Tip: press <span class="kbd">esc</span> to skip loading when possible.
                </div>
            </div>
        </div>
    </div>

    <!-- Your app container -->
    <div id="iframe-container"></div>

    <script>
        // --------------- FAST-FEEL LOADER ---------------
        const fill = document.getElementById('fill');
        const logEl = document.getElementById('log');
        const telem = document.getElementById('telemetry');
        const h1 = document.getElementById('theh1');
        const p = document.getElementById('thep');
        const preloader = document.getElementById('preloader');

        const statuses = [
            "This might take a bit",
            "Downloading assets",
            "Negotiating TLS & ALPN",
            "Priming DNS cache",
            "Compiling WASM shims",
            "Optimizing routes",
            "Initializing workers",
            "Establishing secure channels",
            "Bootstrapping runtime",
            "Verifying integrity checks",
            "Routing via nearest edge",
            "Starting proxy"
        ];

        let progress = 0;
        let t0 = performance.now();
        function rand(min, max) { return Math.random() * (max - min) + min }
        function fmt(n) { return n.toFixed(1) }
        function tickTelemetry() {
            const mbps = fmt(rand(32, 110));
            const ops = fmt(rand(1.6, 6.8));
            const rtt = Math.round(rand(12, 44));
            telem.textContent = `${mbps} MB/s • ${ops}k ops/s • RTT ~ ${rtt} ms`;
        }
        const log = [];
        function pushLine(text, ok = false) {
            const ts = new Date().toISOString().split('T')[1].split('Z')[0];
            log.push(`<span class="line"><span class="key">[${ts}]</span> <span class="val">${text}</span> ${ok ? '<span class="ok">✔</span>' : ''}</span>`);
            if (log.length > 7) log.shift();
            logEl.innerHTML = log.join("<br/>");
            logEl.scrollTop = logEl.scrollHeight;
        }
        let statusIdx = 0;
        function cycleStatus() {
            if (statusIdx < statuses.length) {
                thep.textContent = statuses[statusIdx] + "…";
                statusIdx++;
            }
        }
        pushLine("initializing runtime");
        pushLine("warming caches");
        pushLine("opening secure channels");

        const stepTimer = setInterval(() => {
            const dt = performance.now() - t0;
            const target = Math.min(96, 100 * (1 - Math.exp(-dt / 900)));
            const burst = Math.random() < 0.25 ? rand(0.8, 2.4) : rand(0.2, 0.6);
            progress = Math.min(96, Math.max(progress, target + burst - 1));
            fill.style.width = progress.toFixed(2) + "%";

            tickTelemetry();
            if (Math.random() < 0.5) cycleStatus();
            if (Math.random() < 0.6) pushLine(`stage/${statusIdx || 1} ok`, true);
        }, 110);

        function finishAndHide() {
            let w = progress;
            const fin = setInterval(() => {
                w += Math.max(0.6, (100 - w) * 0.22);
                fill.style.width = Math.min(100, w).toFixed(2) + "%";
                if (w >= 99.6) {
                    clearInterval(fin);
                    clearInterval(stepTimer);
                    pushLine("handoff to application", true);
                    preloader.classList.add('hidden');
                    document.getElementById('iframe-container').style.display = 'block';
                    document.dispatchEvent(new CustomEvent('app:preloader:done'));
                }
            }, 40);
        }

        // Allow skipping when mostly loaded
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && progress > 70) finishAndHide();
        });

        // Old helper compatibility (as requested)
        window.lowtaperfade = function () {
            document.getElementById('fadeout').style = "opacity: 0;";
        }
        window.highslipperybuzz = function () {
            document.getElementById('fadeout').style = "opacity: 1;";
            document.getElementById('theh1').innerText = "This is taking a while…";
            document.getElementById('thep').innerText = "Server could be overloaded, or the target is slow.";
        }

        // Explicit hook to hide loader programmatically
        window.preloaderDone = function () {
            finishAndHide();
        }
        // ------------------------------------------------

        // ---------------- SCRAMJET / BAREMUX ----------------
        const { ScramjetController } = $scramjetLoadController();
        const scramjet = new ScramjetController({
            files: {
                wasm: "/scram/scramjet.wasm.wasm",
                all: "/scram/scramjet.all.js",
                sync: "/scram/scramjet.sync.js"
            },
        });

        scramjet.init();
        navigator.serviceWorker.register("/sw.js").catch(() => { });

        const connection = new BareMux.BareMuxConnection("/baremux/worker.js");


        function $store(defaultSettings, options = {}) {
            const { ident = 'settings', backing = 'localstorage', autosave = 'auto' } = options;
            const storageKey = ident;

            let settings = { ...defaultSettings };
            if (backing === 'localstorage') {
                try {
                    const stored = localStorage.getItem(storageKey);
                    if (stored) {
                        settings = { ...defaultSettings, ...JSON.parse(stored) };
                    }
                } catch (e) {
                    console.warn('Failed to load settings from localStorage:', e);
                }
            }

            function save() {
                if (backing === 'localstorage') {
                    try {
                        localStorage.setItem(storageKey, JSON.stringify(settings));
                    } catch (e) {
                        console.warn('Failed to save settings to localStorage:', e);
                    }
                }
            }
            return new Proxy(settings, {
                set(target, property, value) {
                    target[property] = value;
                    if (autosave === 'auto') {
                        save();
                    }
                    return true;
                },
                get(target, property) {
                    if (property === 'save') {
                        return save;
                    }
                    return target[property];
                }
            });
        }

        const store = $store(
            {
                wispurl:
                    wispurl ||
                    (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/wisp/",
                proxy: "",
                transport: "/epoxy/index.mjs",
            },
            { ident: "settings", backing: "localstorage", autosave: "auto" }
        );
        self.store = store;

        async function waitForTransport() {
            let attempts = 0;
            const maxAttempts = 10;

            while (attempts < maxAttempts) {
                try {
                    await connection.setTransport("/epoxy/index.mjs", [{ wisp: store.wispurl }]);
                    return;
                } catch (e) {
                    attempts++;
                    pushLine(`Transport init failed (attempt ${attempts} of ${maxAttempts})`);
                    await new Promise(res => setTimeout(res, 800 * attempts));
                }
            }
        }

        function mountFrameAndGo(url) {
            const container = document.getElementById("iframe-container");
            container.innerHTML = ""; // clear previous
            const frame = scramjet.createFrame();
            container.appendChild(frame.frame);

            // Set up URL change detection similar to PeteZah browser
            frame.addEventListener("urlchange", (e) => {
                if (!e.url) return;

                console.log("URL change detected:", e.url);

                // Get page title from iframe content
                let title = "Loading...";
                try {
                    const iframeDoc = frame.frame.contentDocument || frame.frame.contentWindow.document;
                    title = iframeDoc.title || new URL(e.url).hostname || "Untitled";
                } catch (err) {
                    title = new URL(e.url).hostname || "Untitled";
                }

                // Send URL and title change to parent window
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'urlchange',
                        url: e.url,
                        title: title,
                        frameId: window.frameElement?.id
                    }, '*');
                }
            });

            frame.frame.onload = () => {
                window.preloaderDone();

                // Also send initial load event
                if (window.parent && window.parent !== window) {
                    try {
                        const iframeDoc = frame.frame.contentDocument || frame.frame.contentWindow.document;
                        const title = iframeDoc.title || new URL(url).hostname || "Untitled";
                        window.parent.postMessage({
                            type: 'frameload',
                            url: url,
                            title: title,
                            frameId: window.frameElement?.id
                        }, '*');
                    } catch (err) {
                        // Cross-origin restrictions
                        window.parent.postMessage({
                            type: 'frameload',
                            url: url,
                            title: new URL(url).hostname || "Untitled",
                            frameId: window.frameElement?.id
                        }, '*');
                    }
                }
            };

            frame.go(url);
        }

        async function loadFromHash() {
            // Show loader while switching
            document.getElementById('iframe-container').style.display = 'none';
            document.getElementById('fadeout').classList.remove('hidden');
            document.getElementById('preloader').classList.remove('hidden');

            // Reset loader headline/desc for a new navigation cycle
            h1.textContent = "Deploying proxy…";
            p.textContent = "Optimizing routes, warming caches, and negotiating TLS.";
            progress = 0; fill.style.width = "0%";

            const raw = window.location.hash.substring(1);
            let url = raw ? raw : "https://start.duckduckgo.com/";
            if (!/^https?:\/\//i.test(url) && raw) url = "https://" + raw;

            await waitForTransport();
            mountFrameAndGo(url);
        }

        window.addEventListener("hashchange", loadFromHash);
        window.addEventListener("load", loadFromHash);
        // ----------------------------------------------------
    </script>
</body>

</html>